<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç­ç´šå°ç®¡å®¶ V9.0 (iOSå°ˆç”¨ç‰ˆ)</title>
    
    <!-- iOS PWA è¨­å®šï¼šåŠ å…¥ä¸»ç•«é¢å¾Œæœƒè®Šå…¨è¢å¹• App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç­ç´šå°ç®¡å®¶">
    <meta name="format-detection" content="telephone=no">
    
    <!-- å­—å‹è¼‰å…¥ -->
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    
    <!-- æ ¸å¿ƒå‡½å¼åº« (React + Tailwind) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- éŒ¯èª¤æ””æˆªå™¨ï¼šé˜²æ­¢ç™½ç•«é¢ï¼Œå¦‚æœæœ‰éŒ¯æœƒé¡¯ç¤ºç´…å­— -->
    <script>
        window.onerror = function(msg, url, line) {
            document.body.innerHTML = '<div style="padding:40px;color:red;font-size:24px;background:white;height:100vh;"><h1>âš ï¸ ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤</h1><p>'+msg+'</p><p>Line: '+line+'</p><p>è«‹æˆªåœ–æ­¤ç•«é¢çµ¦å·¥ç¨‹å¸«ã€‚</p></div>';
            return false;
        };
    </script>

    <style>
        /* æ ¸å¿ƒæ¨£å¼è¨­å®š */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #FEF9F2;
            background-image: 
                linear-gradient(#E8E8E8 1px, transparent 1px),
                linear-gradient(90deg, #E8E8E8 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
            color: #5D4037;
            font-size: 18px; 
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 3D æŒ‰éˆ•æ•ˆæœ */
        .btn-3d {
            transition: transform 0.05s, box-shadow 0.05s;
            border: 3px solid #5D4037;
            box-shadow: 4px 4px 0px #5D4037;
            border-radius: 16px; 
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            font-size: 1.2rem; 
        }
        
        .btn-3d:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #5D4037;
        }

        /* å°èˆªæŒ‰éˆ•ç‰¹æ•ˆ */
        .nav-btn-settings {
            background-color: #FF5252;
            color: white;
            border: 3px solid #5D4037;
            box-shadow: 0px 4px 0px #3E2723;
            transform: translateY(-10px);
            z-index: 50;
        }
        
        .nav-btn-settings.active {
            background-color: #FF1744;
            transform: translateY(-16px) scale(1.1);
            box-shadow: 0px 6px 0px #3E2723;
            border: 3px solid #FFF;
            outline: 3px solid #5D4037;
        }

        /* é¡è‰²èˆ‡å¡ç‰‡ */
        .bg-mint { background-color: #CDF0EA; }
        .bg-yellow { background-color: #FDFD96; }
        .bg-pink { background-color: #FFC4C4; }
        .bg-blue-soft { background-color: #C4E4FF; }
        .bg-purple-soft { background-color: #E2C4FF; }
        .bg-orange-soft { background-color: #FFD8B1; }
        .bg-red-alert { background-color: #FF8A80; color: white; }
        .bg-line { background-color: #06C755; color: white; }
        .bg-dark { background-color: #4A4A4A; color: white; }

        .text-coffee { color: #5D4037; }
        .border-coffee { border-color: #5D4037; }

        .doodle-card {
            background: white;
            border: 3px solid #5D4037;
            border-radius: 24px;
            box-shadow: 6px 6px 0px rgba(93, 64, 55, 0.2);
        }

        .input-hand {
            border: 3px solid #5D4037;
            border-radius: 12px;
            padding: 12px 16px; 
            background: #FFF;
            font-family: 'ZCOOL KuaiLe', cursive;
            outline: none;
            width: 100%;
            font-size: 1.1rem; 
            user-select: text;
            -webkit-user-select: text;
        }
        .input-hand:focus { box-shadow: 3px 3px 0px #5D4037; }

        .modal-scroll {
            max-height: 70vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-scroll::-webkit-scrollbar { width: 0; }
        
        /* ç¢ºä¿åº•éƒ¨å°èˆªæ¬„åœ¨ iPhone ä¸Šä¸æœƒè¢«æ“‹ä½ */
        .safe-area-nav {
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // 1. å…§å»º Icon ç³»çµ± (è§£æ±ºç™½ç•«é¢å•é¡Œçš„æ ¸å¿ƒ)
        // ç›´æ¥å°‡ SVG è·¯å¾‘å¯«åœ¨ç¨‹å¼ç¢¼ä¸­ï¼Œä¸ä¾è³´ä»»ä½•å¤–éƒ¨æª”æ¡ˆ
        const ICON_PATHS = {
            User: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z",
            Users: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M16 3.13a4 4 0 0 1 0 7.75 M23 21v-2a4 4 0 0 0-3-3.87",
            Clock: "M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z M12 6v6l4 2",
            BookOpen: "M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",
            AlertCircle: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z", 
            CheckCircle2: "M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3",
            MessageCircle: "M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z",
            MicOff: "M1 1l22 22 M9 9v3a3 3 0 0 0 5.12 2.12 M15 9.34V4a3 3 0 0 0-5.94-.6",
            Coffee: "M18 8h1a4 4 0 0 1 0 8h-1 M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z M6 1v3 M10 1v3 M14 1v3",
            FileWarning: "M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M10 9v4 M10 17h.01",
            Edit3: "M12 20h9 M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z",
            Trash2: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2 M10 11v6 M14 11v6",
            ChevronDown: "M6 9l6 6 6-6",
            ChevronUp: "M18 15l-6-6-6 6",
            Save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z M17 21v-8H7v8 M7 3v5h8",
            Share2: "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14L21 3",
            Plus: "M12 5v14 M5 12h14",
            X: "M18 6L6 18 M6 6l12 12",
            Briefcase: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",
            Stethoscope: "M4.8 2.3A.3.3 0 0 1 5 2h14a.3.3 0 0 1 .2.3v3.3a.3.3 0 0 1-.2.3A2.4 2.4 0 0 0 16 8a2.4 2.4 0 0 0-2.4 2.4v3.2a2.4 2.4 0 0 0 2.4 2.4h.1a.4.4 0 0 1 .4.4v2.8a.4.4 0 0 1-.4.4H8a.4.4 0 0 1-.4-.4V16a.4.4 0 0 1 .4-.4h.1A2.4 2.4 0 0 0 10.4 13.6V10.4A2.4 2.4 0 0 0 8 8 2.4 2.4 0 0 0 5.6 5.6A.3.3 0 0 1 5.4 5.3V2.3z",
            Palmtree: "M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2l1-1 1 1h4l1-1 1 1h1zm0 0v8",
            HelpCircle: "M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3 M12 17h.01 M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z",
            Star: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
            PackageX: "M16.5 9.4 7.5 4.21 M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z M3.3 7 12 12 20.7 7 M12 22v-10",
            ClipboardCopy: "M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2 M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1z",
            Smile: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M8 14s1.5 2 4 2 4-2 4-2 M9 9h.01 M15 9h.01",
            Download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3",
            Settings: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z",
            FileSpreadsheet: "M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M14 2v6h6 M8 13h2 M14 13h2 M8 17h2 M14 17h2",
            List: "M8 6h13 M8 12h13 M8 18h13 M3 6h.01 M3 12h.01 M3 18h.01",
            UserCog: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z M19 11v.5 M19 13.5v.5 M17.5 12.5h2.5 M20 12.5h-1",
            Share: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8 M16 6l-4-4-4 4 M12 2v13",
            MoreVertical: "M12 12h.01 M12 5h.01 M12 19h.01",
            LayoutGrid: "M3 3h7v7H3z M14 3h7v7h-7z M14 14h7v7h-7z M3 14h7v7H3z",
            Info: "M12 16v-4 M12 8h.01 M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 12 2 22 12z",
            PenTool: "M12 19l7-7 3 3-7 7-3-3z M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z M2 2l7.586 7.586 M11 11l-4 4",
            AlertTriangle: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01",
            Megaphone: "M3 11l8-5v12l-8-5a2 2 0 0 1 0-2z M11.6 16.4l2.2 2.2a2 2 0 0 0 2.8 0 2 2 0 0 0 0-2.8l-1.4-1.4 M11.6 7.6l1.4-1.4a2 2 0 0 1 2.8 0 2 2 0 0 1 0 2.8l-2.2 2.2",
            Send: "M22 2L11 13 M22 2l-7 20-4-9-9-4 20-7z",
            Smartphone: "M5 2h14a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z M12 18h.01",
            Database: "M3 6c0 1.66 4.03 3 9 3s9-1.34 9-3-4.03-3-9-3-9 1.34-9 3z M3 12c0 1.66 4.03 3 9 3s9-1.34 9-3 M3 18c0 1.66 4.03 3 9 3s9-1.34 9-3 M3 6v12 M21 6v12",
            Upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12",
            Check: "M20 6L9 17l-5-5"
        };

        const { useState, useEffect, useMemo } = React;

        // å»ºç«‹é€šç”¨çš„ Icon å…ƒä»¶
        const Icon = ({ name, size = 24, className = "" }) => {
            const path = ICON_PATHS[name];
            if (!path) return <span style={{fontSize: '12px'}}>?</span>;
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    <path d={path} />
                </svg>
            );
        };

        // å»ºç«‹æ‰€æœ‰å°æ‡‰çš„ Icon å…ƒä»¶
        const Icons = Object.keys(ICON_PATHS).reduce((acc, key) => {
            acc[key] = (props) => <Icon name={key} {...props} />;
            return acc;
        }, {});

        // è§£æ§‹å‡ºæ‰€æœ‰éœ€è¦çš„ Icons
        const { 
            Calendar, User, Users, Clock, BookOpen, AlertCircle, 
            CheckCircle2, MessageCircle, MicOff, Coffee, FileWarning, 
            Edit3, Trash2, ChevronDown, ChevronUp, Save, Share2,
            Plus, X, Briefcase, Stethoscope, Palmtree, HelpCircle, Star, PackageX,
            ClipboardCopy, Smile, Download, Settings, FileSpreadsheet, List, UserCog,
            Share, MoreVertical, LayoutGrid, Info, PenTool, AlertTriangle, Megaphone, Send,
            Smartphone, Database, Upload, Check
        } = Icons;

        // --- å¸¸æ•¸å®šç¾© ---
        const PERIODS = [
            { id: 'early', label: 'æ—©ä¿®' },
            { id: 'p1', label: 'ç¬¬ä¸€ç¯€' },
            { id: 'p2', label: 'ç¬¬äºŒç¯€' },
            { id: 'p3', label: 'ç¬¬ä¸‰ç¯€' },
            { id: 'p4', label: 'ç¬¬å››ç¯€' },
            { id: 'lunch', label: 'åˆé¤' },
            { id: 'nap', label: 'åˆä¼‘' },
            { id: 'p5', label: 'ç¬¬äº”ç¯€' },
            { id: 'p6', label: 'ç¬¬å…­ç¯€' },
            { id: 'p7', label: 'ç¬¬ä¸ƒç¯€' },
            { id: 'p8', label: 'ç¬¬å…«ç¯€' },
        ];

        const DEFAULT_BEHAVIORS = [
            { id: 'item_missing', label: 'ç‰©å“æœªå¸¶', icon: 'PackageX', color: 'bg-pink' },
            { id: 'late_class', label: 'æ™šé€²æ•™å®¤', icon: 'Clock', color: 'bg-yellow' },
            { id: 'rude', label: 'å°å¸«ä¸ç¦®è²Œ', icon: 'MicOff', color: 'bg-pink' },
            { id: 'noise', label: 'åµé¬§å¹²æ“¾', icon: 'AlertCircle', color: 'bg-pink' },
            { id: 'chat', label: 'èŠå¤©', icon: 'MessageCircle', color: 'bg-yellow' },
            { id: 'note', label: 'å‚³ç´™æ¢', icon: 'FileWarning', color: 'bg-yellow' },
            { id: 'other_book', label: 'çœ‹èª²å¤–æ›¸', icon: 'BookOpen', color: 'bg-yellow' },
            { id: 'sleep', label: 'æ‰“çŒç¡', icon: 'Coffee', color: 'bg-pink' },
            { id: 'no_hw_cls', label: 'ä½œæ¥­æœªäº¤', icon: 'FileWarning', color: 'bg-pink' },
            { id: 'other', label: 'å…¶ä»–', icon: 'PenTool', color: 'bg-blue-soft' },
        ];

        const ATTENDANCE_TYPES = [
            { id: 'late', label: 'é²åˆ°', icon: Clock, color: 'bg-yellow' },
            { id: 'sick', label: 'ç—…å‡', icon: Stethoscope, color: 'bg-mint' },
            { id: 'official', label: 'å…¬å‡', icon: Briefcase, color: 'bg-blue-soft' },
            { id: 'personal', label: 'äº‹å‡', icon: Palmtree, color: 'bg-purple-soft' },
            { id: 'other_leave', label: 'å…¶ä»–', icon: HelpCircle, color: 'bg-gray-200' },
            { id: 'absent', label: 'ç¼ºå¸­', icon: AlertCircle, color: 'bg-pink' },
        ];

        const CONTACT_BOOK_TYPES = [
            { id: 'cb_missing', label: 'è¯çµ¡ç°¿ç¼ºäº¤', icon: X, color: 'bg-pink' },
            { id: 'cb_no_sign', label: 'å®¶é•·æœªç°½å', icon: PenTool, color: 'bg-yellow' },
            { id: 'cb_good', label: 'è¯çµ¡ç°¿å„ªè‰¯', icon: Star, color: 'bg-mint' },
        ];

        const DEFAULT_SUBJECTS = [
            { id: 'chinese', label: 'åœ‹æ–‡' },
            { id: 'english', label: 'è‹±èª' },
            { id: 'math', label: 'æ•¸å­¸' },
            { id: 'science', label: 'ç†åŒ–' },
            { id: 'civics', label: 'å…¬æ°‘' },
            { id: 'history', label: 'æ­·å²' },
            { id: 'geo', label: 'åœ°ç†' },
        ];

        const ICON_MAP = {
            PackageX, Clock, MicOff, AlertCircle, MessageCircle, FileWarning, BookOpen, Coffee, HelpCircle, PenTool
        };

        const DB_KEY = 'classLogDB_V9_Final_Standalone'; 

        // --- ç¨ç«‹å…ƒä»¶ï¼šå­¸ç”Ÿé¸æ“‡å™¨ ---
        const StudentSelectorModal = ({ isOpen, onClose, students, selectedList, title, onToggle }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-[#FEF9F2] w-full max-w-sm rounded-2xl border-4 border-coffee shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                    <div className="bg-yellow p-4 border-b-4 border-coffee flex justify-between items-center">
                    <h3 className="text-2xl font-bold text-coffee">é»é¸å­¸ç”Ÿ</h3>
                    <button onClick={onClose} className="bg-white p-2 rounded-full border-2 border-coffee active:scale-95 transition"><CheckCircle2 size={32} /></button>
                    </div>
                    <div className="bg-yellow px-4 pb-2 text-coffee font-bold opacity-80 border-b-2 border-coffee mb-2">æ­£åœ¨ç™»è¨˜ï¼š{title}</div>
                    <div className="p-4 overflow-y-auto grid grid-cols-4 gap-3 modal-scroll">
                    {students.map(s => (
                        <button key={s.id} onClick={() => onToggle(s.id)} className={`p-2 rounded-xl border-2 border-coffee font-bold text-base flex flex-col items-center justify-center transition-all min-h-[70px] ${selectedList.includes(s.id) ? 'bg-coffee text-white transform scale-105 shadow-lg' : 'bg-white text-coffee hover:bg-gray-100'}`}>
                        <span className="text-sm opacity-70 mb-1">#{s.id}</span>
                        <span className="truncate w-full text-center text-lg">{s.name}</span>
                        </button>
                    ))}
                    </div>
                    <div className="p-4 bg-white border-t-4 border-coffee text-center"><button onClick={onClose} className="btn-3d w-full bg-mint py-4 text-2xl">å®Œ æˆ</button></div>
                </div>
                </div>
            );
        };

        // --- ä¸»ç¨‹å¼ ---
        function App() {
            const [activeTab, setActiveTab] = useState('basic'); 
            
            const [currentDate, setCurrentDate] = useState(() => {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                return new Date(now.getTime() - offset).toISOString().split('T')[0];
            });

            const safeLoad = (key, defaultVal) => {
                try {
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : defaultVal;
                } catch (e) {
                console.error("Load Error:", e);
                return defaultVal; 
                }
            };

            const [db, setDb] = useState(() => safeLoad(DB_KEY, {}));
            const [saveStatus, setSaveStatus] = useState('idle');

            const [subjects, setSubjects] = useState(() => safeLoad('classLogSubjects', DEFAULT_SUBJECTS));
            const [behaviors, setBehaviors] = useState(() => safeLoad('classLogBehaviors', DEFAULT_BEHAVIORS));
            const [students, setStudents] = useState(() => safeLoad('classLogStudents', Array.from({ length: 30 }, (_, i) => ({ id: i + 1, name: `${i + 1}è™Ÿ` }))));
            const [teacherNote, setTeacherNote] = useState(() => safeLoad('classLogTeacherNote', ''));

            const todayData = useMemo(() => {
                const data = db[currentDate] || {};
                return {
                week: data.week || '',
                dutyOfficer: data.dutyOfficer || '',
                dutyStudent: data.dutyStudent || '',
                attendanceData: data.attendanceData || {},
                missingData: data.missingData || {},
                classLogData: data.classLogData || {},
                periodNotes: data.periodNotes || {},
                incidentLog: data.incidentLog || ''
                };
            }, [db, currentDate]);

            const updateToday = (field, value) => {
                setSaveStatus('saving');
                setDb(prevDb => {
                const newDb = {
                    ...prevDb,
                    [currentDate]: {
                    ...prevDb[currentDate],
                    [field]: value
                    }
                };
                try {
                    localStorage.setItem(DB_KEY, JSON.stringify(newDb));
                    setTimeout(() => setSaveStatus('saved'), 500);
                } catch (e) {
                    alert("âš ï¸ è­¦å‘Šï¼šå„²å­˜ç©ºé–“ä¸è¶³ï¼");
                }
                return newDb;
                });
            };

            useEffect(() => localStorage.setItem('classLogSubjects', JSON.stringify(subjects)), [subjects]);
            useEffect(() => localStorage.setItem('classLogBehaviors', JSON.stringify(behaviors)), [behaviors]);
            useEffect(() => localStorage.setItem('classLogStudents', JSON.stringify(students)), [students]);
            useEffect(() => localStorage.setItem('classLogTeacherNote', teacherNote), [teacherNote]);

            const [newSubjectName, setNewSubjectName] = useState('');
            const [isAddingSubject, setIsAddingSubject] = useState(false);
            const [newBehaviorName, setNewBehaviorName] = useState('');
            const [isEditingBehaviors, setIsEditingBehaviors] = useState(false);
            const [isSelectorOpen, setIsSelectorOpen] = useState(false);
            const [selectorConfig, setSelectorConfig] = useState({ type: '', category: '', period: '' });
            const [selectedStudentReport, setSelectedStudentReport] = useState(1);
            const [bulkNamesInput, setBulkNamesInput] = useState(''); 
            const [currentSubjectId, setCurrentSubjectId] = useState('');
            const [currentLogPeriod, setCurrentLogPeriod] = useState('p1');

            useEffect(() => {
                if (subjects.length > 0 && !currentSubjectId) setCurrentSubjectId(subjects[0].id);
                else if (currentSubjectId && !subjects.find(s => s.id === currentSubjectId)) setCurrentSubjectId(subjects[0]?.id || '');
            }, [subjects, currentSubjectId]);

            const toggleStudent = (studentId) => {
                const { type, category, period } = selectorConfig;
                if (type === 'attendance') {
                const currentList = todayData.attendanceData[category] || [];
                const newList = currentList.includes(studentId) ? currentList.filter(id => id !== studentId) : [...currentList, studentId];
                updateToday('attendanceData', { ...todayData.attendanceData, [category]: newList });
                } 
                else if (type === 'missing') {
                const currentList = todayData.missingData[category] || [];
                const newList = currentList.includes(studentId) ? currentList.filter(id => id !== studentId) : [...currentList, studentId];
                updateToday('missingData', { ...todayData.missingData, [category]: newList });
                } 
                else if (type === 'log') {
                const periodData = todayData.classLogData[period] || {};
                const currentList = periodData[category] || [];
                const newList = currentList.includes(studentId) ? currentList.filter(id => id !== studentId) : [...currentList, studentId];
                updateToday('classLogData', { ...todayData.classLogData, [period]: { ...periodData, [category]: newList } });
                }
            };

            const getSelectedList = () => {
                const { type, category, period } = selectorConfig;
                if (type === 'attendance') return todayData.attendanceData[category] || [];
                if (type === 'missing') return todayData.missingData[category] || [];
                if (type === 'log') return todayData.classLogData[period]?.[category] || [];
                return [];
            };

            const updatePeriodNote = (val) => {
                updateToday('periodNotes', { ...todayData.periodNotes, [currentLogPeriod]: val });
            };

            const handleBulkImportNames = () => {
                if (!bulkNamesInput.trim()) return;
                const names = bulkNamesInput.split(/\n/).map(n => n.trim()).filter(n => n);
                if (confirm(`å³å°‡åŒ¯å…¥ ${names.length} ä½å­¸ç”Ÿï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                setStudents(names.map((name, index) => ({ id: index + 1, name: name })));
                setBulkNamesInput('');
                alert('åŒ¯å…¥æˆåŠŸï¼');
                }
            };
            const handleUpdateStudentName = (id, newName) => setStudents(students.map(s => s.id === id ? { ...s, name: newName } : s));
            const handleAddSubject = () => { if (newSubjectName.trim()) { const newId = `sub_${Date.now()}`; setSubjects([...subjects, { id: newId, label: newSubjectName.trim() }]); setNewSubjectName(''); setIsAddingSubject(false); setCurrentSubjectId(newId); } };
            const handleDeleteSubject = (id, e) => { e.stopPropagation(); if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç§‘ç›®ï¼Ÿ')) setSubjects(subjects.filter(s => s.id !== id)); };
            const handleAddBehavior = () => { if (newBehaviorName.trim()) { const colors = ['bg-pink', 'bg-yellow', 'bg-mint', 'bg-blue-soft']; setBehaviors([...behaviors, { id: `beh_${Date.now()}`, label: newBehaviorName.trim(), icon: 'AlertCircle', color: colors[Math.floor(Math.random() * colors.length)] }]); setNewBehaviorName(''); } };
            const handleDeleteBehavior = (id, e) => { e.stopPropagation(); if (confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ')) setBehaviors(behaviors.filter(b => b.id !== id)); };
            
            const handleBehaviorClick = (behaviorId) => {
                if (isEditingBehaviors) return;
                if (behaviorId === 'other') {
                const note = prompt(`è«‹è¼¸å…¥ ${PERIODS.find(p=>p.id===currentLogPeriod)?.label} çš„å…¶ä»–èªªæ˜ï¼š`, todayData.periodNotes[currentLogPeriod] || '');
                if (note !== null) updatePeriodNote(note);
                openSelector('log', behaviorId, currentLogPeriod);
                } else {
                openSelector('log', behaviorId, currentLogPeriod);
                }
            };
            const openSelector = (type, category, period = null) => { setSelectorConfig({ type, category, period }); setIsSelectorOpen(true); };

            const handleBackupData = () => {
                const backupData = { version: '9.0', timestamp: new Date().toISOString(), allData: db, settings: { subjects, behaviors, students, teacherNote } };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
                const link = document.createElement('a'); link.href = dataStr; link.download = `ç­ç´šå°ç®¡å®¶_å‚™ä»½_${currentDate}.json`; link.click();
            };
            const handleRestoreData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (confirm(`ç¢ºå®šè¦é‚„åŸè³‡æ–™å—ï¼Ÿ`)) {
                    if (backup.allData) { setDb(backup.allData); localStorage.setItem(DB_KEY, JSON.stringify(backup.allData)); }
                    if (backup.settings) {
                        if (backup.settings.subjects) setSubjects(backup.settings.subjects);
                        if (backup.settings.behaviors) setBehaviors(backup.settings.behaviors);
                        if (backup.settings.students) setStudents(backup.settings.students);
                        if (backup.settings.teacherNote) setTeacherNote(backup.settings.teacherNote);
                    }
                    alert('âœ… é‚„åŸæˆåŠŸï¼');
                    }
                } catch { alert('âŒ æª”æ¡ˆéŒ¯èª¤'); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };
            const downloadCSV = (content, filename) => {
                const bom = '\uFEFF'; const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; link.click();
            };

            const getWeeklyStats = (studentId) => {
                const dates = []; const today = new Date(currentDate);
                for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); }
                let stats = { attendance: {}, missing: {}, behavior: {} };
                let detailedBehaviors = [], detailedAttendance = [], detailedMissing = [];
                
                dates.forEach(date => {
                const data = db[date]; if (!data) return;
                const dateStr = date.slice(5).replace('-','/');
                
                if (data.attendanceData) Object.keys(data.attendanceData).forEach(k => { if (data.attendanceData[k]?.includes(studentId)) { stats.attendance[k] = (stats.attendance[k] || 0) + 1; const type = ATTENDANCE_TYPES.find(t => t.id === k); detailedAttendance.push(`${dateStr} ${type ? type.label : k}`); } });
                if (data.missingData) Object.keys(data.missingData).forEach(k => { if (data.missingData[k]?.includes(studentId)) { let label = k; const sub = subjects.find(s => s.id === k); const cb = CONTACT_BOOK_TYPES.find(c => c.id === k); if (sub) label = sub.label + 'ä½œæ¥­ç¼ºäº¤'; if (cb) label = cb.label; stats.missing[label] = (stats.missing[label] || 0) + 1; detailedMissing.push(`${dateStr} ${label}`); } });
                if (data.classLogData) Object.keys(data.classLogData).forEach(periodId => { const pLog = data.classLogData[periodId]; const pNote = data.periodNotes?.[periodId]; if (pLog) { Object.keys(pLog).forEach(bId => { if (pLog[bId]?.includes(studentId)) { const b = behaviors.find(be => be.id === bId); let label = b ? b.label : 'å…¶ä»–'; let displayLabel = label; if (bId === 'other') { if (pNote) displayLabel = pNote; else displayLabel = "å…¶ä»–é•è¦"; } else { if (pNote) displayLabel = `${label} (${pNote})`; } const periodLabel = PERIODS.find(p => p.id === periodId)?.label || periodId; stats.behavior[label] = (stats.behavior[label] || 0) + 1; detailedBehaviors.push(`${dateStr} ${periodLabel}ï¼š${displayLabel}`); } }); } });
                });
                return { dates, stats, detailedBehaviors: detailedBehaviors.reverse(), detailedAttendance: detailedAttendance.reverse(), detailedMissing: detailedMissing.reverse() };
            };

            const getDailyStudentViolations = () => {
                const studentViolations = {};
                PERIODS.forEach(p => {
                const logs = todayData.classLogData[p.id]; if (!logs) return;
                behaviors.forEach(b => { const list = logs[b.id]; if (list && list.length > 0) { list.forEach(studentId => { if (!studentViolations[studentId]) studentViolations[studentId] = []; studentViolations[studentId].push(`${p.label}: ${b.label}`); }); } });
                });
                return studentViolations;
            };

            const exportWholeClassWeekly = () => { const dates = []; const today = new Date(currentDate); for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); } const dateRange = `${dates[dates.length-1]} ~ ${dates[0]}`; let csv = `å…¨ç­é€±å ±è¡¨\nçµ±è¨ˆç¯„åœ,${dateRange}\n\n`; csv += `åº§è™Ÿ,å§“å,ç¼ºå‹¤ç¸½æ•¸,ç¼ºäº¤ç¸½æ•¸,é•è¦ç¸½æ•¸,ç¼ºå‹¤æ˜ç´°,ç¼ºäº¤æ˜ç´°,é•è¦æ˜ç´°\n`; students.forEach(student => { const { stats, detailedBehaviors, detailedAttendance, detailedMissing } = getWeeklyStats(student.id); const totalAtt = Object.values(stats.attendance).reduce((a,b) => a+b, 0); const totalMiss = Object.values(stats.missing).reduce((a,b) => a+b, 0); const totalBeh = Object.values(stats.behavior).reduce((a,b) => a+b, 0); csv += `${student.id},${student.name},${totalAtt},${totalMiss},${totalBeh},"${detailedAttendance.join('ï¼›')}","${detailedMissing.join('ï¼›')}","${detailedBehaviors.join('ï¼›')}"\n`; }); downloadCSV(csv, `å…¨ç­é€±å ±è¡¨_${currentDate}.csv`); };
            const exportStudentWeekly = () => { const s = students.find(s => s.id === selectedStudentReport); if(!s) return alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿ'); const { dates, stats } = getWeeklyStats(selectedStudentReport); let csv = `å­¸ç”Ÿå€‹åˆ¥é€±å ±è¡¨\nåº§è™Ÿ,${s.id}\nå§“å,${s.name}\nçµ±è¨ˆç¯„åœ,${dates[dates.length-1]} ~ ${dates[0]}\n\n`; csv += `é¡åˆ¥,é …ç›®,æ¬¡æ•¸\n`; Object.entries(stats.attendance).forEach(([k, v]) => csv += `ç¼ºå‹¤,${ATTENDANCE_TYPES.find(t=>t.id===k)?.label||k},${v}\n`); Object.entries(stats.missing).forEach(([k, v]) => csv += `ç¼ºäº¤,${k},${v}\n`); Object.entries(stats.behavior).forEach(([k, v]) => csv += `é•è¦,${k},${v}\n`); downloadCSV(csv, `${s.name}_é€±å ±è¡¨.csv`); };
            const exportDailyLog = () => { let csv = `ç­ç´šæ—¥èªŒ,æ—¥æœŸï¼š${currentDate},é€±æ¬¡ï¼š${todayData.week},å€¼æ—¥ï¼š${todayData.dutyOfficer}/${todayData.dutyStudent}\n\n`; csv += `ã€åˆ°æ ¡ã€‘\né¡åˆ¥,å­¸ç”Ÿ\n`; ATTENDANCE_TYPES.forEach(t => { const list = todayData.attendanceData[t.id]?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€') || ''; if(list) csv += `${t.label},"${list}"\n`; }); csv += `\nã€ä½œæ¥­ã€‘\né …ç›®,ç¼ºäº¤\n`; const getMissingNames = (list) => list?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€') || ''; CONTACT_BOOK_TYPES.forEach(t => { const str = getMissingNames(todayData.missingData[t.id]); if(str) csv += `${t.label},"${str}"\n`; }); subjects.forEach(s => { const str = getMissingNames(todayData.missingData[s.id]); if(str) csv += `${s.label}ç¼ºäº¤,"${str}"\n`; }); csv += `\nã€èª²å ‚ã€‘\næ™‚æ®µ,è¡Œç‚º,å­¸ç”Ÿ,å‚™è¨»\n`; PERIODS.forEach(p => { const logs = todayData.classLogData[p.id]; const note = todayData.periodNotes[p.id] || ''; if (logs) { behaviors.forEach(b => { const rawList = logs[b.id]; if (rawList && rawList.length > 0) { const names = rawList.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€'); csv += `${p.label},${b.label},"${names}","${note}"\n`; } }); } if ((!logs || Object.keys(logs).every(k => logs[k].length === 0)) && note) { csv += `${p.label},å‚™è¨»,,"${note}"\n`; } }); csv += `\nã€å¶ç™¼ã€‘\n"${todayData.incidentLog.replace(/"/g, '""')}"\n`; downloadCSV(csv, `ç­ç´šæ—¥èªŒ_${currentDate}.csv`); };
            const generateParentMessage = (studentId) => { const s = students.find(stud => stud.id === studentId); if (!s) return "è«‹å…ˆé¸æ“‡å­¸ç”Ÿ..."; const { dates, stats, detailedBehaviors, detailedAttendance, detailedMissing } = getWeeklyStats(studentId); const dateRange = `${dates[dates.length-1].slice(5).replace('-','/')} ~ ${dates[0].slice(5).replace('-','/')}`; let msg = ""; if (teacherNote.trim()) { msg += `ğŸ“¢ â­â­â­ é‡è¦é€šçŸ¥ â­â­â­\n${teacherNote}\n\n------------------------------\n\n`; } msg += `ã€ç­ç´šé€±å ±ã€‘è¦ªæ„›çš„å®¶é•·æ‚¨å¥½ï¼Œé€™æ˜¯ ${s.name} æœ¬é€± (${dateRange}) çš„åœ¨æ ¡è¡¨ç¾æ‘˜è¦ï¼š\n\n`; if (detailedAttendance.length > 0) { msg += `ğŸ“… è€ƒå‹¤ç´€éŒ„ï¼š\n`; detailedAttendance.forEach(item => { msg += `   - ${item}\n`; }); } else { msg += `ğŸ“… è€ƒå‹¤ç´€éŒ„ï¼šå…¨å‹¤ ğŸ‘\n`; } if (detailedMissing.length > 0) { msg += `ğŸ“š ä½œæ¥­èˆ‡ç‰©å“ï¼š\n`; detailedMissing.forEach(item => { msg += `   - ${item}\n`; }); } else { msg += `ğŸ“š ä½œæ¥­ç¹³äº¤ï¼šç‹€æ³è‰¯å¥½ ğŸ‘\n`; } if (detailedBehaviors.length > 0) { msg += `âš ï¸ èª²å ‚å¸¸è¦æé†’ï¼š\n`; detailedBehaviors.forEach(item => { msg += `   - ${item}\n`; }); } else { msg += `âœ¨ èª²å ‚è¡¨ç¾ï¼šéµå®ˆå¸¸è¦ï¼Œè¡¨ç¾ç©©å®šã€‚\n`; } msg += `\nå†è«‹æ‚¨å”åŠ©é—œå¿ƒå­©å­çš„å­¸ç¿’ç‹€æ³ï¼Œè¬è¬æ‚¨çš„é…åˆï¼`; return msg; };
            const handleLineShare = (text) => { const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`; window.open(lineUrl, '_blank'); };
            const copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½è¨Šæ¯ï¼')); };

            // --- Views ---
            const renderBasicInfo = () => (
                <div className="space-y-6 pb-24">
                <div className="doodle-card p-5 space-y-4 bg-white"><div className="flex gap-3"><div className="flex-1"><label className="text-base font-bold opacity-70">æ—¥æœŸ</label><input type="date" value={currentDate} onChange={e => setCurrentDate(e.target.value)} className="input-hand text-lg" /></div><div className="w-1/3"><label className="text-base font-bold opacity-70">é€±æ¬¡</label><input type="text" value={todayData.week} onChange={e => updateToday('week', e.target.value)} className="input-hand text-center text-lg" /></div></div><div className="flex gap-3"><div className="flex-1"><label className="text-base font-bold opacity-70">å€¼æ—¥å¹¹éƒ¨</label><input type="text" value={todayData.dutyOfficer} onChange={e => updateToday('dutyOfficer', e.target.value)} className="input-hand text-lg" /></div><div className="flex-1"><label className="text-base font-bold opacity-70">å€¼æ—¥ç”Ÿ</label><input type="text" value={todayData.dutyStudent} onChange={e => updateToday('dutyStudent', e.target.value)} className="input-hand text-lg" /></div></div></div>
                <div className="doodle-card p-5 bg-white relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-4 bg-mint border-b-2 border-coffee"></div><h3 className="text-2xl font-bold mb-5 mt-3 flex items-center gap-2"><Clock size={28} /> åˆ°æ ¡ç‹€æ³</h3><div className="grid grid-cols-2 gap-4">{ATTENDANCE_TYPES.map(type => { const count = todayData.attendanceData[type.id]?.length || 0; return <button key={type.id} onClick={() => openSelector('attendance', type.id)} className={`btn-3d p-3 flex items-center justify-between px-4 ${type.color} text-lg h-14`}><div className="flex items-center gap-2"><type.icon size={20} /><span>{type.label}</span></div>{count > 0 && <span className="bg-coffee text-white text-sm px-3 py-1 rounded-full">{count}</span>}</button> })}</div></div>
                <div className="doodle-card p-5 bg-white relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-4 bg-yellow border-b-2 border-coffee"></div>
                    <h3 className="text-2xl font-bold mb-5 mt-3 flex items-center gap-2"><FileWarning size={28} /> ä½œæ¥­èˆ‡è¯çµ¡ç°¿</h3>
                    <div className="grid grid-cols-1 gap-3 mb-4">{CONTACT_BOOK_TYPES.map(item => <button key={item.id} onClick={() => openSelector('missing', item.id)} className={`btn-3d w-full py-3 flex justify-between px-5 text-lg ${item.color}`}><div className="flex items-center gap-3"><item.icon size={22}/><span>{item.label}</span></div>{todayData.missingData[item.id]?.length > 0 && <span className="bg-coffee text-white text-sm px-3 py-1 rounded-full">{todayData.missingData[item.id].length}</span>}</button>)}</div>
                    <div className="border-t-2 border-coffee pt-4 space-y-4">
                    <div className="flex justify-between items-center"><h4 className="font-bold text-coffee opacity-80 text-lg">å„ç§‘ä½œæ¥­ç¼ºäº¤</h4><button onClick={() => setIsAddingSubject(!isAddingSubject)} className="text-sm bg-mint px-3 py-1 rounded-full border-2 border-coffee hover:bg-green-200"><Plus size={16} /></button></div>
                    {isAddingSubject && <div className="flex gap-2"><input autoFocus type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="input-hand text-lg py-2" /><button onClick={handleAddSubject} className="btn-3d px-4 bg-coffee text-white text-lg">OK</button></div>}
                    {subjects.length > 0 ? (
                        <div className="space-y-3">
                        <div className="flex gap-2">
                            <select value={currentSubjectId} onChange={(e) => setCurrentSubjectId(e.target.value)} className="input-hand text-lg flex-1 bg-gray-50 font-bold border-2 border-coffee">{subjects.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select>
                            <button onClick={(e) => handleDeleteSubject(currentSubjectId, e)} className="btn-3d bg-pink text-white px-3"><Trash2 size={24}/></button>
                        </div>
                        <button onClick={() => openSelector('missing', currentSubjectId)} className="btn-3d w-full bg-white py-4 text-lg flex justify-between px-5 border-2 border-coffee shadow-sm group active:bg-yellow">
                            <span className="font-bold flex items-center gap-2"><Edit3 size={20}/> ç™»è¨˜ {subjects.find(s=>s.id===currentSubjectId)?.label} ç¼ºäº¤</span>
                            {todayData.missingData[currentSubjectId]?.length > 0 ? (
                                <div className="text-right"><span className="bg-pink text-white px-3 py-1 rounded-full text-sm font-bold block w-fit ml-auto mb-1">{todayData.missingData[currentSubjectId].length} äºº</span><span className="text-xs text-pink-600 font-bold block max-w-[150px] truncate">{todayData.missingData[currentSubjectId].sort((a,b)=>a-b).join('ã€')}è™Ÿ</span></div>
                            ) : <span className="text-gray-400 text-sm">é»æ“Šç™»è¨˜</span>}
                        </button>
                        </div>
                    ) : <div className="text-center text-gray-400 py-2">è«‹å…ˆæ–°å¢ç§‘ç›®...</div>}
                    <div className="flex flex-col gap-2 mt-2">{subjects.map(s => { const list = todayData.missingData[s.id]; if (!list || list.length === 0) return null; const sortedList = [...list].sort((a,b) => a-b).join('ã€'); return ( <button key={s.id} onClick={() => { setCurrentSubjectId(s.id); openSelector('missing', s.id); }} className="bg-white border-2 border-coffee px-3 py-2 rounded-xl text-sm font-bold flex items-center justify-between shadow-sm hover:bg-gray-50 w-full text-left"><span className="flex items-center gap-2 text-lg text-coffee">{s.label}</span><div className="flex items-center gap-2 overflow-hidden"><span className="text-coffee opacity-80 truncate text-sm">ç¼ºäº¤ï¼š{sortedList}è™Ÿ</span><span className="bg-pink text-white px-2 py-1 rounded-full text-xs shrink-0">{list.length}äºº</span></div></button> ) })}</div>
                    </div>
                </div>
                </div>
            );

            const renderLog = () => (
                <div className="space-y-5 pb-24">
                <div className="doodle-card p-4 bg-white flex flex-col gap-3">
                    <div className="flex items-center gap-2">
                    <label className="font-bold text-coffee text-xl shrink-0">é¸æ“‡æ™‚æ®µï¼š</label>
                    <select value={currentLogPeriod} onChange={(e) => setCurrentLogPeriod(e.target.value)} className="input-hand text-2xl font-bold bg-yellow border-2 border-coffee h-14 flex-1">
                        {PERIODS.map(p => <option key={p.id} value={p.id}>{p.label}</option>)}
                    </select>
                    </div>
                    <div className="relative">
                    <input type="text" value={todayData.periodNotes[currentLogPeriod] || ''} onChange={(e) => updatePeriodNote(e.target.value)} placeholder={`åœ¨æ­¤è¼¸å…¥${PERIODS.find(p=>p.id===currentLogPeriod)?.label}çš„å‚™è¨»...`} className="input-hand text-lg bg-gray-50 pr-10" />
                    <PenTool size={20} className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                    </div>
                </div>
                <div className="flex justify-between items-center px-1">
                    <h4 className="font-bold text-coffee opacity-80 text-xl">é•è¦é …ç›®</h4>
                    <button onClick={() => setIsEditingBehaviors(!isEditingBehaviors)} className={`px-3 py-1 rounded-full border-2 border-coffee text-sm font-bold flex items-center gap-1 ${isEditingBehaviors ? 'bg-pink text-white' : 'bg-gray-100'}`}><Settings size={16} /> {isEditingBehaviors ? 'å®Œæˆ' : 'ç·¨è¼¯'}</button>
                </div>
                {isEditingBehaviors && <div className="doodle-card p-4 bg-yellow flex gap-3"><input type="text" value={newBehaviorName} onChange={e => setNewBehaviorName(e.target.value)} placeholder="æ–°é•è¦é …ç›®..." className="input-hand text-lg" /><button onClick={handleAddBehavior} className="btn-3d bg-coffee text-white px-4"><Plus size={24}/></button></div>}
                <div className="grid grid-cols-3 gap-3">{behaviors.map(behavior => { const count = todayData.classLogData[currentLogPeriod]?.[behavior.id]?.length || 0; const Icon = ICON_MAP[behavior.icon] || AlertCircle; return ( <button key={behavior.id} onClick={() => handleBehaviorClick(behavior.id)} className={`btn-3d p-2 flex flex-col items-center gap-1 ${behavior.color} min-h-[90px] relative`}>{isEditingBehaviors && <span onClick={(e) => handleDeleteBehavior(behavior.id, e)} className="absolute top-1 right-1 bg-white rounded-full p-1 border border-coffee text-red-500 z-20"><X size={14} strokeWidth={3} /></span>}<Icon size={32} /><span className="text-xl text-center leading-tight">{behavior.label}</span>{!isEditingBehaviors && count > 0 && <span className="absolute top-[-5px] right-[-5px] w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center border-2 border-coffee text-sm z-10">{count}</span>}</button> ) })}</div>
                <div className="mt-2 p-4 bg-white border-2 border-coffee rounded-2xl shadow-sm min-h-[80px]">
                    <p className="font-bold opacity-60 mb-2 text-sm border-b-2 border-coffee border-dashed pb-1 flex justify-between"><span>{PERIODS.find(p=>p.id===currentLogPeriod)?.label} å·²ç´€éŒ„ï¼š</span>{(!todayData.classLogData[currentLogPeriod] || Object.values(todayData.classLogData[currentLogPeriod]).every(arr => arr.length === 0)) && !todayData.periodNotes[currentLogPeriod] && <span className="text-gray-400 font-normal">å°šç„¡è³‡æ–™</span>}</p>
                    {behaviors.map(b => { const list = todayData.classLogData[currentLogPeriod]?.[b.id]; if(!list || list.length===0) return null; return ( <div key={b.id} className="flex gap-2 mb-1 text-lg"><span className="font-bold text-coffee shrink-0">{b.label}:</span><span className="text-gray-700">{list.map(id => students.find(s=>s.id===id)?.name || id).join('ã€')}</span></div> )})}
                    {todayData.periodNotes[currentLogPeriod] && (<div className="flex gap-2 mt-2 text-lg text-blue-600 bg-blue-50 p-2 rounded-lg"><span className="font-bold shrink-0"><PenTool size={18} className="inline mr-1"/>å‚™è¨»:</span><span>{todayData.periodNotes[currentLogPeriod]}</span></div>)}
                </div>
                <div className="doodle-card p-5 bg-white mt-8"><h3 className="text-2xl font-bold mb-3 flex items-center gap-2"><MessageCircle size={28} /> å…¨æ—¥å¶ç™¼/ç¸½çµ</h3><textarea value={todayData.incidentLog} onChange={(e) => updateToday('incidentLog', e.target.value)} className="w-full h-32 p-4 border-2 border-coffee rounded-xl outline-none font-bold resize-none bg-gray-50 text-lg" placeholder="ä»Šæ—¥å…¶ä»–è£œå……..." /></div>
                </div>
            );

            const renderReview = () => {
                const dailyStudentViolations = getDailyStudentViolations();
                const hasViolations = Object.keys(dailyStudentViolations).length > 0;
                return (
                <div className="pb-24 space-y-5">
                    <div className="flex justify-end gap-2"><span className={`text-sm font-bold flex items-center gap-1 ${saveStatus === 'saved' ? 'text-green-600' : 'text-orange-500'}`}>{saveStatus === 'saved' ? <><Check size={16}/> è³‡æ–™å·²åŒæ­¥</> : 'å„²å­˜ä¸­...'}</span><button onClick={exportDailyLog} className="btn-3d bg-yellow px-5 py-3 flex items-center gap-2 text-coffee font-bold text-lg"><FileSpreadsheet size={24}/> åŒ¯å‡º Excel</button></div>
                    <div className="bg-white border-2 border-coffee p-6 min-h-[500px] text-base font-mono shadow-xl relative leading-relaxed">
                    <h2 className="text-center text-2xl font-bold mb-6 border-b-2 border-coffee pb-3">{todayData.week || '____'}é€± ç­ç´šæ—¥èªŒ ({currentDate})</h2>
                    <div className="mb-6 grid grid-cols-2 gap-4 text-lg"><div>å€¼æ—¥å¹¹éƒ¨: {todayData.dutyOfficer}</div><div>å€¼æ—¥ç”Ÿ: {todayData.dutyStudent}</div></div>
                    <div className="mb-6 border border-coffee p-3"><h3 className="font-bold mb-2 bg-gray-200 p-2 text-lg">ç¼ºå‹¤</h3>{ATTENDANCE_TYPES.map(t => todayData.attendanceData[t.id]?.length > 0 && <div key={t.id} className="py-2 border-b border-dashed text-lg"><b>{t.label}:</b> {todayData.attendanceData[t.id].map(id=>students.find(s=>s.id===id)?.name).join('ã€')}</div>)}</div>
                    <div className="mb-6 border border-coffee p-3"><h3 className="font-bold mb-2 bg-gray-200 p-2 text-lg">ç¼ºäº¤</h3>{CONTACT_BOOK_TYPES.map(t => todayData.missingData[t.id]?.length > 0 && <div key={t.id} className="py-2 border-b border-dashed text-lg"><b>{t.label}:</b> {todayData.missingData[t.id].map(id=>students.find(s=>s.id===id)?.name).join('ã€')}</div>)}{subjects.map(s => todayData.missingData[s.id]?.length > 0 && <div key={s.id} className="py-2 border-b border-dashed text-lg"><b>{s.label}:</b> {todayData.missingData[s.id].map(id=>students.find(s=>s.id===id)?.name).join('ã€')}</div>)}</div>
                    <div className="mb-6 border border-coffee"><h3 className="font-bold bg-red-100 p-2 border-b border-coffee text-lg text-red-800 flex items-center gap-2"><AlertTriangle size={20}/> ä»Šæ—¥é•è¦çµ±è¨ˆ</h3><div className="p-3 space-y-2">{hasViolations ? (Object.entries(dailyStudentViolations).map(([studentId, violations]) => { const student = students.find(s => s.id === Number(studentId)); return ( <div key={studentId} className="border-b border-dashed last:border-0 pb-1"><span className="font-bold text-lg text-coffee mr-2">{student?.name || `${studentId}è™Ÿ`}:</span><span className="text-gray-700">{violations.join('ã€')}</span></div> ); })) : ( <div className="text-center text-gray-400 py-2">ä»Šæ—¥ç„¡èª²å ‚é•è¦ç´€éŒ„ ğŸ‘</div> )}</div></div>
                    <div className="mb-6 border border-coffee"><h3 className="font-bold bg-gray-200 p-2 border-b border-coffee text-lg">èª²å ‚ç•°å¸¸ & å‚™è¨»</h3>{PERIODS.map(p => { const logs=todayData.classLogData[p.id]; const note=todayData.periodNotes[p.id]; if((!logs || Object.keys(logs).every(k=>logs[k].length===0)) && !note) return null; return ( <div key={p.id} className="p-3 border-b border-coffee last:border-0"><div className="font-bold text-coffee mb-1 text-lg">{p.label}</div>{logs && behaviors.map(b => logs[b.id]?.length > 0 && <div key={b.id} className="pl-4 flex text-lg"><span className="w-32 text-gray-600">- {b.label}:</span><span>{logs[b.id].map(id=>students.find(s=>s.id===id)?.name).join('ã€')}</span></div>)}{note && <div className="pl-4 text-lg text-blue-600 mt-1">å‚™è¨»: {note}</div>}</div> ) })}</div>
                    <div className="border border-coffee p-3 min-h-[120px]"><h3 className="font-bold mb-2 bg-gray-200 p-2 text-lg">å…¨æ—¥å¶ç™¼</h3><p className="text-lg">{todayData.incidentLog}</p></div>
                    </div>
                </div>
                );
            };

            const renderReports = () => {
                const s = students.find(stud => stud.id === selectedStudentReport);
                if (!s) return <div className="p-8 text-center text-gray-500 font-bold text-xl mt-10">è«‹å…ˆå¾ä¸Šæ–¹é¸å–®é¸æ“‡ä¸€ä½å­¸ç”Ÿ</div>;
                const { dates, stats, detailedBehaviors, detailedAttendance, detailedMissing } = getWeeklyStats(selectedStudentReport);
                const msg = generateParentMessage(selectedStudentReport);
                return (
                <div className="pb-24 space-y-6">
                    <div className="doodle-card p-5 bg-orange-soft border-4 border-white shadow-lg"><h3 className="font-bold mb-3 flex items-center gap-2 text-2xl text-coffee"><FileSpreadsheet size={32}/> æ•™å¸«å°ˆç”¨ï¼šé€±å ±è¡¨</h3><p className="text-sm opacity-70 mb-3 font-bold">åŒ¯å‡ºåŒ…å«å…¨ç­ç¼ºå‹¤ã€ç¼ºäº¤èˆ‡é•è¦çš„ Excel çµ±è¨ˆè¡¨</p><button onClick={exportWholeClassWeekly} className="w-full btn-3d bg-white py-4 text-coffee flex items-center justify-center gap-3 text-xl hover:bg-orange-50"><Download size={24} /> ä¸‹è¼‰å…¨ç­é€±å ±è¡¨</button></div>
                    <div className="border-t-4 border-coffee border-dashed my-2 opacity-50"></div>
                    <div className="doodle-card p-4 bg-white border-4 border-red-500 shadow-xl transform rotate-1"><h3 className="font-bold mb-2 text-2xl flex items-center gap-2 text-red-600 border-b-2 border-red-200 pb-2"><Megaphone size={32} className="animate-bounce"/> è€å¸«çš„è©±</h3><textarea value={teacherNote} onChange={(e) => setTeacherNote(e.target.value)} className="w-full h-32 p-3 border-2 border-red-200 rounded-xl outline-none text-xl font-bold text-coffee bg-red-50" placeholder="åœ¨æ­¤è¼¸å…¥é‡è¦äº‹é …ï¼Œæ‰€æœ‰å®¶é•·éƒ½æœƒçœ‹åˆ°..." /></div>
                    <div className="doodle-card p-5 bg-yellow flex items-center justify-between"><div className="flex items-center gap-3"><User size={36} /><div><div className="text-sm opacity-60 font-bold">æŸ¥çœ‹å­¸ç”Ÿ</div><select value={selectedStudentReport} onChange={(e) => setSelectedStudentReport(Number(e.target.value))} className="bg-transparent text-2xl font-bold outline-none border-b-2 border-coffee min-w-[140px] py-1">{students.map(s => <option key={s.id} value={s.id}>{s.id}. {s.name}</option>)}</select></div></div><div className="text-right text-sm font-bold opacity-60">çµ±è¨ˆç¯„åœ<br/>éå» 5 å¤©</div></div>
                    <div className="grid grid-cols-2 gap-4"><div className="doodle-card p-4 bg-white flex flex-col items-center justify-center min-h-[120px]"><div className="text-5xl font-bold text-coffee">{Object.values(stats.attendance).reduce((a,b)=>a+b, 0)}</div><div className="text-sm font-bold opacity-60 mt-1">æœ¬é€±ç¼ºå‹¤</div></div><div className="doodle-card p-4 bg-white flex flex-col items-center justify-center min-h-[120px]"><div className="text-5xl font-bold text-pink-500">{Object.values(stats.missing).reduce((a,b)=>a+b, 0)}</div><div className="text-sm font-bold opacity-60 mt-1">æœ¬é€±ç¼ºäº¤</div></div></div>
                    <div className="doodle-card p-4 bg-white border-2 border-coffee"><h4 className="font-bold text-xl text-coffee border-b border-dashed border-coffee pb-2 mb-2">è©³ç´°ç´€éŒ„é è¦½</h4><div className="space-y-2 text-sm">{detailedAttendance.length > 0 && (<div><strong className="text-mint-600 block mb-1">è€ƒå‹¤ï¼š</strong><ul className="list-disc pl-5 text-gray-600">{detailedAttendance.map((s, i) => <li key={i}>{s}</li>)}</ul></div>)}{detailedMissing.length > 0 && (<div><strong className="text-yellow-600 block mb-1">ä½œæ¥­ï¼š</strong><ul className="list-disc pl-5 text-gray-600">{detailedMissing.map((s, i) => <li key={i}>{s}</li>)}</ul></div>)}{detailedBehaviors.length > 0 && (<div><strong className="text-pink-600 block mb-1">é•è¦ï¼š</strong><ul className="list-disc pl-5 text-gray-600">{detailedBehaviors.map((s, i) => <li key={i}>{s}</li>)}</ul></div>)}{detailedAttendance.length === 0 && detailedMissing.length === 0 && detailedBehaviors.length === 0 && (<p className="text-gray-400 italic">æœ¬é€±ç„¡ç‰¹æ®Šç´€éŒ„ï¼Œè¡¨ç¾è‰¯å¥½ï¼</p>)}</div></div>
                    <div className="space-y-4"><div className="bg-white border-2 border-coffee p-4 rounded-xl text-lg whitespace-pre-wrap h-48 overflow-y-auto leading-relaxed shadow-inner">{msg}</div><div className="flex gap-3 items-stretch"><button onClick={() => handleLineShare(msg)} className="flex-[3] btn-3d bg-line py-4 text-xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"><Send size={24} /> å‚³é€/è¤‡è£½è¨Šæ¯çµ¦å®¶é•·</button><button onClick={() => copyToClipboard(msg)} className="flex-1 btn-3d bg-mint py-4 flex flex-col items-center justify-center gap-1 text-xs opacity-80" title="åƒ…è¤‡è£½æ–‡å­—"><ClipboardCopy size={24} /> <span>è¤‡è£½</span></button><button onClick={exportStudentWeekly} className="flex-1 btn-3d bg-gray-100 py-4 flex flex-col items-center justify-center gap-1 text-xs opacity-80" title="ä¸‹è¼‰ Excel"><Download size={24} /> <span>ä¸‹è¼‰</span></button></div></div>
                </div>
                );
            };

            const renderSettings = () => (
                <div className="pb-24 space-y-8">
                <button onClick={() => setActiveTab('manual')} className="w-full btn-3d bg-blue-soft py-4 text-coffee flex items-center justify-center gap-3 text-xl"><BookOpen size={28} /> ğŸ“– æŸ¥çœ‹ä½¿ç”¨èªªæ˜æ›¸</button>
                <div className="doodle-card p-5 bg-dark border-4 border-coffee"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 text-white border-b-2 border-gray-500 pb-3"><Database size={30}/> å‚™ä»½èˆ‡é‚„åŸ</h3><div className="grid grid-cols-2 gap-4"><button onClick={handleBackupData} className="btn-3d bg-mint py-3 flex flex-col items-center justify-center gap-1"><Download size={24} className="text-coffee"/><span className="text-sm text-coffee">ä¸‹è¼‰å‚™ä»½æª”</span></button><div className="relative"><input type="file" accept=".json" onChange={handleRestoreData} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button className="btn-3d bg-yellow py-3 flex flex-col items-center justify-center gap-1 w-full"><Upload size={24} className="text-coffee"/><span className="text-sm text-coffee">é‚„åŸè³‡æ–™</span></button></div></div></div>
                <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"><UserCog size={30}/> å­¸ç”Ÿåå–®ç®¡ç†</h3><div className="mb-6"><label className="text-lg font-bold opacity-70 mb-2 block">æ‰¹æ¬¡åŒ¯å…¥å§“å (ä¸€è¡Œä¸€å€‹)</label><textarea className="input-hand h-40 text-lg" placeholder="ç‹å°æ˜&#10;æå¤§åŒ&#10;é™³é›…å©·" value={bulkNamesInput} onChange={(e) => setBulkNamesInput(e.target.value)} /><button onClick={handleBulkImportNames} className="mt-4 w-full btn-3d bg-yellow py-3 text-coffee text-xl"><Download size={24} className="mr-2"/> åŒ¯å…¥åå–®</button></div><div className="max-h-60 overflow-y-auto border-t-2 border-coffee pt-4">{students.map(s => (<div key={s.id} className="flex items-center gap-2 mb-3"><span className="font-bold w-12 text-lg">#{s.id}</span><input type="text" value={s.name} onChange={(e) => handleUpdateStudentName(s.id, e.target.value)} className="input-hand py-2 text-lg" /></div>))}</div></div>
                <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"><BookOpen size={30}/> ç§‘ç›®ç®¡ç†</h3><div className="flex gap-2 mb-4"><input type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="input-hand text-lg" placeholder="æ–°ç§‘ç›®..." /><button onClick={handleAddSubject} className="btn-3d bg-coffee text-white px-4 text-xl"><Plus size={24}/></button></div><div className="flex flex-wrap gap-3">{subjects.map(s => (<span key={s.id} className="bg-gray-100 border-2 border-coffee px-3 py-2 rounded-full text-lg flex items-center gap-2">{s.label}<X size={20} className="cursor-pointer text-gray-400 hover:text-red-500" onClick={(e) => handleDeleteSubject(s.id, e)}/></span>))}</div></div>
                </div>
            );

            const renderManual = () => (
                <div className="pb-24 space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300">
                <div className="doodle-card p-5 bg-orange-soft"><h3 className="text-2xl font-bold mb-3 flex items-center gap-2 border-b-2 border-coffee pb-2"><Download size={28}/> å¦‚ä½•å®‰è£ (åŠ å…¥ä¸»ç•«é¢)</h3><p className="mb-4 font-bold text-coffee opacity-80">å‹™å¿…å°‡æ­¤ç¶²é ã€åŠ å…¥ä¸»ç•«é¢ã€‘ï¼Œå³å¯åƒ App ä¸€æ¨£å…¨è¢å¹•ä½¿ç”¨ï¼Œä¸”è³‡æ–™æ›´å®‰å…¨ï¼</p><div className="grid grid-cols-1 gap-4"><div className="bg-white p-4 rounded-xl border-2 border-dashed border-coffee"><h4 className="font-bold text-xl mb-2 flex items-center gap-2"><Share size={20}/> iPhone (Safari)</h4><ol className="list-decimal pl-5 space-y-1"><li>é»é¸ä¸‹æ–¹é¸å–®ä¸­é–“çš„ã€Œåˆ†äº«ã€åœ–ç¤ºã€‚</li><li>å¾€ä¸‹æ»‘å‹•é¸å–®ã€‚</li><li>é¸æ“‡ <span className="marker-highlight px-1">ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</span>ã€‚</li></ol></div><div className="bg-white p-4 rounded-xl border-2 border-dashed border-coffee"><h4 className="font-bold text-xl mb-2 flex items-center gap-2"><MoreVertical size={20}/> Android (Chrome)</h4><ol className="list-decimal pl-5 space-y-1"><li>é»é¸å³ä¸Šè§’çš„ã€Œä¸‰å€‹é»ã€é¸å–®ã€‚</li><li>é¸æ“‡ <span className="marker-highlight px-1">ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€</span>ã€‚</li></ol></div></div></div>
                <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-2"><LayoutGrid size={28}/> åŠŸèƒ½å°è¦½</h3><div className="space-y-4">{[{icon: UserCog, label: 'è¨­å®š', desc: 'ç¬¬ä¸€æ¬¡è«‹å…ˆä¾†é€™ï¼åŒ¯å…¥å­¸ç”Ÿåå–®ã€ç®¡ç†ç§‘ç›®ã€‚', color: 'bg-red-alert'}, {icon: User, label: 'é»å', desc: 'æ¯æ—¥ä¾‹è¡Œã€‚ç´€éŒ„é²åˆ°ã€è«‹å‡ã€ä½œæ¥­ç¼ºäº¤ã€‚', color: 'bg-mint'}, {icon: Edit3, label: 'ç´€éŒ„', desc: 'èª²å ‚é•è¦è¿½è¹¤ã€‚ä½¿ç”¨é¸å–®åˆ‡æ›ç¯€æ¬¡ï¼Œå¿«é€Ÿç™»è¨˜ã€‚', color: 'bg-yellow'}, {icon: List, label: 'æ—¥èªŒ', desc: 'è‡ªå‹•å½™æ•´ä»Šæ—¥ç´€éŒ„ï¼Œå¯åŒ¯å‡ºä»Šæ—¥ Excelã€‚', color: 'bg-pink'}, {icon: FileSpreadsheet, label: 'å ±è¡¨', desc: 'ä¸‹è¼‰ã€å…¨ç­é€±å ±è¡¨ã€‘èˆ‡ç”¢ç”Ÿã€å€‹åˆ¥å®¶é•·é€šçŸ¥ã€‘ã€‚', color: 'bg-blue-soft'}].map((item, idx) => (<div key={idx} className="flex items-start gap-3"><div className={`w-12 h-12 rounded-full ${item.color} flex items-center justify-center shrink-0 border-2 border-coffee`}><item.icon size={24} className="text-white"/></div><div><h4 className="font-bold text-xl">{item.label}</h4><p className="text-base opacity-70 leading-snug">{item.desc}</p></div></div>))}</div></div>
                <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-3 flex items-center gap-2 border-b-2 border-coffee pb-2"><Info size={28}/> å¸¸è¦‹å•é¡Œ</h3><ul className="list-disc pl-5 space-y-3"><li><span className="font-bold">è³‡æ–™å­˜åœ¨å“ªï¼Ÿ</span><br/>å­˜åœ¨æ‰‹æ©Ÿç€è¦½å™¨è£¡ï¼ä¸æœƒä¸Šå‚³é›²ç«¯ï¼Œéš±ç§å®‰å…¨ã€‚</li><li><span className="font-bold">æ›æ‰‹æ©Ÿè³‡æ–™é‚„åœ¨å—ï¼Ÿ</span><br/>ä¸åœ¨å–”ï¼å»ºè­°æ¯é€±äº”ä½¿ç”¨ã€Œå ±è¡¨ã€åŠŸèƒ½åŒ¯å‡º Excel å‚™ä»½ã€‚</li></ul></div>
                <div className="text-center opacity-60 text-sm">Designed with â¤ï¸ for Teachers</div>
                </div>
            );

            return (
                <div className="min-h-screen w-full max-w-md mx-auto relative overflow-hidden">
                <header className="pt-8 pb-3 px-6 flex justify-between items-center"><h1 className="text-4xl font-bold text-coffee tracking-wider transform -rotate-1 flex items-center gap-3"><BookOpen size={40} strokeWidth={3} /> ç­ç´šæ—¥èªŒ</h1><button onClick={() => setActiveTab('manual')} className="bg-white p-2 rounded-full border-2 border-coffee shadow-sm active:scale-95 transition" title="ä½¿ç”¨èªªæ˜æ›¸"><HelpCircle size={28} className="text-coffee"/></button></header>
                <main className="px-5 h-full pt-4">{activeTab === 'basic' && renderBasicInfo()}{activeTab === 'log' && renderLog()}{activeTab === 'review' && renderReview()}{activeTab === 'report' && renderReports()}{activeTab === 'settings' && renderSettings()}{activeTab === 'manual' && renderManual()}</main>
                <StudentSelectorModal 
                    isOpen={isSelectorOpen}
                    onClose={() => setIsSelectorOpen(false)}
                    students={students}
                    selectedList={getSelectedList()}
                    title={selectorConfig.type === 'attendance' ? ATTENDANCE_TYPES.find(t => t.id === selectorConfig.category)?.label : selectorConfig.type === 'missing' ? (CONTACT_BOOK_TYPES.find(t => t.id === selectorConfig.category)?.label || subjects.find(s => s.id === selectorConfig.category)?.label + 'ç¼ºäº¤') : `${PERIODS.find(p => p.id === selectorConfig.period)?.label} - ${behaviors.find(b => b.id === selectorConfig.category)?.label}`}
                    onToggle={toggleStudent}
                />
                <nav className="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[98%] max-w-sm bg-[#FFF] border-3 border-coffee rounded-2xl shadow-[4px_4px_0px_#5D4037] flex justify-between px-3 py-3 z-40 safe-area-nav">
                    {[{ id: 'basic', icon: User, label: 'é»å', color: 'bg-mint' }, { id: 'log', icon: Edit3, label: 'ç´€éŒ„', color: 'bg-yellow' }, { id: 'review', icon: List, label: 'æ—¥èªŒ', color: 'bg-pink' }, { id: 'report', icon: FileSpreadsheet, label: 'å ±è¡¨', color: 'bg-blue-soft' }, { id: 'settings', icon: Settings, label: 'è¨­å®š', color: 'bg-red-alert' }].map(tab => ( <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 flex flex-col items-center p-2 rounded-xl transition-all duration-300 ${tab.id === 'settings' ? 'nav-btn-settings ' + (activeTab === 'settings' ? 'active' : '') : (activeTab === tab.id ? `${tab.color} -translate-y-4 border-2 border-coffee shadow-sm` : 'opacity-60')}`}><tab.icon size={32} className={tab.id === 'settings' ? 'text-white' : 'text-coffee'}/><span className={`text-xs font-black mt-1 ${tab.id === 'settings' ? 'text-white' : 'text-coffee'}`}>{tab.label}</span></button> ))}
                </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
